#!/bin/bash
# List all slots
# Usage: slot list

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
LIB_DIR="$SCRIPT_DIR/lib"

# Source common functions
# shellcheck source=lib/common.sh
source "$LIB_DIR/common.sh"

show_help() {
  cat << EOF
Usage: slot list

List all active slots for the current project.

Options:
  -h, --help    Show this help message
EOF
}

# Handle help flag
if [ "${1:-}" = "-h" ] || [ "${1:-}" = "--help" ]; then
  show_help
  exit 0
fi

echo "Active slots for $SLOT_PROJECT_NAME:"
echo ""

# Batch all data collection in single SSH call
SLOT_DATA=$(ssh "$SLOT_REMOTE_HOST" bash << REMOTE_SCRIPT
  set -euo pipefail
  BASE_DIR="$SLOT_REMOTE_BASE"
  PROJECT="$SLOT_PROJECT_NAME"
  
  # Get all slot directories (must have docker-compose file)
  for slot_path in "\$BASE_DIR"/*/; do
    slot=\$(basename "\$slot_path")
    
    # Skip if no compose file (not a real slot)
    if [ ! -f "\$slot_path/docker-compose.yml" ] && [ ! -f "\$slot_path/docker-compose.dev.yml" ]; then
      continue
    fi
    
    # Count running containers for this slot
    containers=\$(docker ps --filter "name=\${PROJECT}-\${slot}" -q 2>/dev/null | wc -l || echo "0")
    
    # Output: slot|containers
    echo "\${slot}|\${containers}"
  done
REMOTE_SCRIPT
)

if [ "$SLOT_DATA" = "NO_SLOTS" ]; then
  echo "  No slots found"
  exit 0
fi

printf "%-15s %-10s\n" "NAME" "STATUS"
echo "----------------------------"

# Process collected data
while IFS='|' read -r slot containers; do
  # Determine status
  containers="${containers//[[:space:]]/}"  # Trim whitespace
  if [ "$containers" -gt 0 ] 2>/dev/null; then
    status="running ($containers)"
  else
    status="stopped"
  fi
  
  printf "%-15s %-10s\n" "$slot" "$status"
done <<< "$SLOT_DATA"

