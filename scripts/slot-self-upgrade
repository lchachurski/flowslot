#!/bin/bash
# Upgrade flowslot to latest version
# Usage: slot self upgrade [--remote] [--edge]

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "$SCRIPT_DIR/lib/common.sh"

FLOWSLOT_DIR="$(dirname "$SCRIPT_DIR")"
UPDATE_REMOTE=false
USE_EDGE=false

show_help() {
  cat << EOF
Usage: slot self upgrade [--remote] [--edge]

Upgrade flowslot to the latest version.

Options:
  --edge      Update to main branch (bleeding edge, may be unstable)
  --remote    Also update remote server scripts (idle-check, etc.)
  -h, --help  Show this help message

By default, updates to the latest stable release (git tag).
EOF
}

# Parse flags
while [[ "$#" -gt 0 ]]; do
  case "$1" in
    --remote)
      UPDATE_REMOTE=true
      ;;
    --edge)
      USE_EDGE=true
      ;;
    -h|--help)
      show_help
      exit 0
      ;;
    *)
      die "Unknown option: $1\n$(show_help)"
      ;;
  esac
  shift
done

# Find config before changing directories (needed for --remote)
ORIGINAL_PWD="$PWD"
if [ "$UPDATE_REMOTE" = true ]; then
  if ! CONFIG_FILE=$(find_config 2>/dev/null); then
    die "Cannot update remote: .slotconfig not found. Run from a project directory with 'slot self init' done."
  fi
  # shellcheck source=/dev/null
  set -a
  source "$CONFIG_FILE"
  set +a
  
  if [ -z "${SLOT_REMOTE_HOST:-}" ]; then
    die "SLOT_REMOTE_HOST not set in .slotconfig"
  fi
fi

cd "$FLOWSLOT_DIR"
git fetch --tags origin

# Get current version
CURRENT=$(git describe --tags --exact-match HEAD 2>/dev/null || echo "untagged")

if [ "$USE_EDGE" = true ]; then
  # Bleeding edge: pull from main
  log_info "Updating to bleeding edge (main branch)..."
  git checkout main 2>/dev/null || git checkout -b main origin/main
  git pull origin main
  success "Updated to main branch (edge)"
else
  # Stable: checkout latest tag
  LATEST_TAG=$(git tag --sort=v:refname | tail -1 || echo "")
  
  if [ -z "$LATEST_TAG" ]; then
    die "No version tags found. Use --edge to update from main branch."
  fi
  
  if [ "$CURRENT" = "$LATEST_TAG" ]; then
    log_info "Already on latest version: $LATEST_TAG"
  else
    log_info "Updating from $CURRENT to $LATEST_TAG..."
    git checkout "$LATEST_TAG"
    success "Updated to version $LATEST_TAG"
  fi
fi

# Update remote if requested (config already loaded above)
if [ "$UPDATE_REMOTE" = true ]; then
  log_info "Updating remote scripts on $SLOT_REMOTE_HOST..."
  
  # Extract idle-check script from user-data.sh and deploy it
  USER_DATA_FILE="$FLOWSLOT_DIR/infra/user-data.sh"
  if [ ! -f "$USER_DATA_FILE" ]; then
    die "user-data.sh not found at $USER_DATA_FILE"
  fi
  
  # Extract the idle-check script (between 'cat > ... <<' and 'IDLE_SCRIPT')
  TEMP_SCRIPT=$(mktemp)
  awk '/cat > \/usr\/local\/bin\/flowslot-idle-check << '\''IDLE_SCRIPT'\''/,/^IDLE_SCRIPT$/ {
    if (/^IDLE_SCRIPT$/) exit
    if (/cat > \/usr\/local\/bin\/flowslot-idle-check/) next
    print
  }' "$USER_DATA_FILE" > "$TEMP_SCRIPT"
  
  # Deploy to remote
  scp "$TEMP_SCRIPT" "$SLOT_REMOTE_HOST:/tmp/flowslot-idle-check"
  ssh "$SLOT_REMOTE_HOST" "sudo mv /tmp/flowslot-idle-check /usr/local/bin/flowslot-idle-check && sudo chmod +x /usr/local/bin/flowslot-idle-check"
  rm -f "$TEMP_SCRIPT"
  
  success "Remote scripts updated"
fi
