#!/bin/bash
# Open (create or resume) a slot
# Usage: slot open <name> [branch]

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
LIB_DIR="$SCRIPT_DIR/lib"

# Source common functions
# shellcheck source=lib/common.sh
source "$LIB_DIR/common.sh"

show_help() {
  cat << EOF
Usage: slot open <name> [branch]

Opens or creates a development slot.

Arguments:
  name      Slot name (lowercase alphanumeric with hyphens only)
  branch    Git branch name (default: main)

Options:
  -h, --help    Show this help message

Examples:
  slot open auth main
  slot open feature-branch feat/new-ui
EOF
}

# Handle help flag
if [ "${1:-}" = "-h" ] || [ "${1:-}" = "--help" ]; then
  show_help
  exit 0
fi

if [ -z "${1:-}" ]; then
  log_error "Slot name required"
  echo ""
  show_help
  exit 1
fi

SLOT_NAME="$1"
BRANCH="${2:-main}"

# Validate slot name
validate_slot_name "$SLOT_NAME"

LOCAL_PATH="$SLOT_SLOTS_DIR/$SLOT_NAME"
REMOTE_PATH="$SLOT_REMOTE_BASE/$SLOT_NAME"

# Check if slot already exists locally
if [ -d "$LOCAL_PATH" ]; then
  log_info "Slot '$SLOT_NAME' already exists locally. Resuming..."
else
  log_info "Creating slot '$SLOT_NAME' on branch '$BRANCH'..."
  
  # Setup local worktree from the bare repo
  log_info "Setting up local worktree..."
  cd "$SLOT_SLOTS_DIR/repo.git"
  
  # Fetch if origin exists
  if git remote get-url origin >/dev/null 2>&1; then
    git fetch --all --prune 2>/dev/null || true
  fi
  
  # Create worktree
  git worktree add "$LOCAL_PATH" "$BRANCH" 2>/dev/null || \
  git worktree add "$LOCAL_PATH" -b "$BRANCH" origin/"$BRANCH" 2>/dev/null || \
  git worktree add "$LOCAL_PATH" HEAD
fi

# Create remote directory (Mutagen will sync files there)
log_info "Setting up remote directory..."
ssh "$SLOT_REMOTE_HOST" bash << REMOTE_SETUP
  set -e
  # Ensure base directory exists with correct permissions
  if [ ! -d '$SLOT_REMOTE_BASE' ]; then
    sudo mkdir -p '$SLOT_REMOTE_BASE'
    sudo chown \$USER:\$USER '$SLOT_REMOTE_BASE'
  fi
  # Create slot directory
  mkdir -p '$REMOTE_PATH'
REMOTE_SETUP

# Copy environment files from templates to local worktree
log_info "Copying environment files..."
if [ -d "$SLOT_TEMPLATE_DIR" ]; then
  find "$SLOT_TEMPLATE_DIR" -name ".env*" -type f | while read -r template_file; do
    rel_path="${template_file#$SLOT_TEMPLATE_DIR/}"
    local_env="$LOCAL_PATH/$rel_path"
    
    # Copy to local (Mutagen will sync to remote)
    mkdir -p "$(dirname "$local_env")"
    cp "$template_file" "$local_env"
    log_info "  Copied: $rel_path"
  done
fi

# Start Mutagen sync (local â†’ remote)
SYNC_NAME="${SLOT_PROJECT_NAME}-${SLOT_NAME}"
log_info "Starting Mutagen sync..."
if mutagen sync list 2>/dev/null | grep -q "Name: $SYNC_NAME"; then
  log_info "  Resuming existing sync..."
  mutagen sync resume "$SYNC_NAME" 2>/dev/null || true
else
  log_info "  Creating new sync..."
  mutagen sync create \
    "$LOCAL_PATH" \
    "$SLOT_REMOTE_HOST:$REMOTE_PATH" \
    --name="$SYNC_NAME" \
    --ignore=".git" \
    --ignore="node_modules" \
    --ignore=".next" \
    --ignore="dist" \
    --ignore="build" \
    --ignore="*.log" \
    --ignore=".DS_Store" \
    --sync-mode=two-way-resolved \
    --default-file-mode=0644 \
    --default-directory-mode=0755
fi

# Wait for sync to complete initial transfer
log_info "Waiting for sync..."
mutagen sync flush "$SYNC_NAME" 2>/dev/null || sleep 3

# Calculate port base
# Count existing slots to assign unique port range
SLOT_NUM=$(ssh "$SLOT_REMOTE_HOST" "ls -d '$SLOT_REMOTE_BASE'/*/ 2>/dev/null | wc -l" || echo 1)
PORT_BASE=$((PORT_BASE_START + SLOT_NUM * PORT_RANGE))

# Get Tailscale IP for accessing services
TAILSCALE_IP=$(ssh "$SLOT_REMOTE_HOST" "tailscale ip -4 2>/dev/null" | head -1 || echo "")

# Start containers with dynamic ports
log_info "Starting containers..."
ssh "$SLOT_REMOTE_HOST" bash << REMOTE_SCRIPT
  set -e
  cd '$REMOTE_PATH'
  
  # Export slot variables
  export SLOT=$SLOT_NUM
  export SLOT_PORT_BASE=$PORT_BASE
  export SLOT_REMOTE_IP="${TAILSCALE_IP:-localhost}"
  export COMPOSE_PROJECT_NAME="${SLOT_PROJECT_NAME}-${SLOT_NAME}"
  
  # Source project-specific port definitions if they exist
  if [ -f 'flowslot-ports.sh' ]; then
    source flowslot-ports.sh
  fi
  
  # Build compose command from configured files
  COMPOSE_FILES="${SLOT_COMPOSE_FILES}"
  COMPOSE_CMD="docker compose"
  for f in \$COMPOSE_FILES; do
    if [ -f "\$f" ]; then
      COMPOSE_CMD="\$COMPOSE_CMD -f \$f"
    fi
  done
  
  # Add flowslot override file if it exists
  if [ -f 'docker-compose.flowslot.yml' ]; then
    COMPOSE_CMD="\$COMPOSE_CMD -f docker-compose.flowslot.yml"
  fi
  
  echo "Running: \$COMPOSE_CMD up -d"
  eval "\$COMPOSE_CMD up -d"
REMOTE_SCRIPT

echo ""
success "Slot '$SLOT_NAME' is ready!"
echo ""
echo "  Local:  $LOCAL_PATH"
echo "  Remote: $SLOT_REMOTE_HOST:$REMOTE_PATH"
echo "  Branch: $BRANCH"
echo "  Ports:  $PORT_BASE - $((PORT_BASE + PORT_RANGE - 1))"
if [ -n "${TAILSCALE_IP:-}" ]; then
  echo "  Access: http://$TAILSCALE_IP:$((PORT_BASE + 1))"
fi
echo ""
echo "Open in Cursor: cursor $LOCAL_PATH"
