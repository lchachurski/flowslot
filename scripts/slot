#!/bin/bash
# Main entry point for flowslot CLI
# Usage: slot <command> [args]

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
LIB_DIR="$SCRIPT_DIR/lib"

# Source common functions
# shellcheck source=lib/common.sh
source "$LIB_DIR/common.sh"

show_help() {
  cat << EOF
Usage: slot <command> [args]

SLOT LIFECYCLE:
  create <name>     Create a new slot
  stop [name]       Stop a slot (keeps files)
  resume [name]     Resume an existing slot
  destroy [name]    Destroy a slot (full delete)

SLOT OPERATIONS:
  list              List all slots
  info [name]       Show slot details (URLs, ports, containers)
  compose [name]    Proxy docker compose commands to remote slot

SERVER:
  server start      Start EC2 instance
  server stop       Stop EC2 instance
  server status     Show EC2 instance status
  server info       Show server resource usage (CPU, RAM, disk)

META:
  self init         Initialize flowslot for this project
  self upgrade      Upgrade flowslot to latest version
  self version      Show flowslot version

Options:
  -h, --help        Show this help message
  -v, --version     Show version

For more information, run: slot <command> --help
EOF
}

# Handle help and version flags
if [ "${1:-}" = "-h" ] || [ "${1:-}" = "--help" ]; then
  show_help
  exit 0
fi

if [ "${1:-}" = "-v" ] || [ "${1:-}" = "--version" ]; then
  "$SCRIPT_DIR/slot-self-version"
  exit 0
fi

# Handle empty command
if [ -z "${1:-}" ]; then
  show_help
  exit 1
fi

case "$1" in
  create)
    shift
    if ! CONFIG_FILE=$(find_config); then
      die ".slotconfig not found. Run 'slot self init' first."
    fi
    # shellcheck source=/dev/null
    set -a  # Auto-export all variables
    source "$CONFIG_FILE"
    set +a
    "$SCRIPT_DIR/slot-create" "$@"
    ;;
  stop)
    shift
    if ! CONFIG_FILE=$(find_config); then
      die ".slotconfig not found. Run 'slot self init' first."
    fi
    # shellcheck source=/dev/null
    set -a
    source "$CONFIG_FILE"
    set +a
    "$SCRIPT_DIR/slot-stop" "$@"
    ;;
  resume)
    shift
    if ! CONFIG_FILE=$(find_config); then
      die ".slotconfig not found. Run 'slot self init' first."
    fi
    # shellcheck source=/dev/null
    set -a
    source "$CONFIG_FILE"
    set +a
    "$SCRIPT_DIR/slot-resume" "$@"
    ;;
  destroy)
    shift
    if ! CONFIG_FILE=$(find_config); then
      die ".slotconfig not found. Run 'slot self init' first."
    fi
    # shellcheck source=/dev/null
    set -a
    source "$CONFIG_FILE"
    set +a
    "$SCRIPT_DIR/slot-destroy" "$@"
    ;;
  list)
    shift
    if ! CONFIG_FILE=$(find_config); then
      die ".slotconfig not found. Run 'slot self init' first."
    fi
    # shellcheck source=/dev/null
    set -a
    source "$CONFIG_FILE"
    set +a
    "$SCRIPT_DIR/slot-list" "$@"
    ;;
  info)
    shift
    if ! CONFIG_FILE=$(find_config); then
      die ".slotconfig not found. Run 'slot self init' first."
    fi
    # shellcheck source=/dev/null
    set -a
    source "$CONFIG_FILE"
    set +a
    "$SCRIPT_DIR/slot-info" "$@"
    ;;
  compose)
    shift
    if ! CONFIG_FILE=$(find_config); then
      die ".slotconfig not found. Run 'slot self init' first."
    fi
    # shellcheck source=/dev/null
    set -a
    source "$CONFIG_FILE"
    set +a
    "$SCRIPT_DIR/slot-compose" "$@"
    ;;
  server)
    shift
    if CONFIG_FILE=$(find_config 2>/dev/null); then
      set -a
      source "$CONFIG_FILE"
      set +a
    fi
    "$SCRIPT_DIR/slot-server" "$@"
    ;;
  self)
    shift
    if [ -z "${1:-}" ]; then
      log_error "Subcommand required for 'slot self'"
      echo ""
      echo "Available subcommands:"
      echo "  init      Initialize flowslot for this project"
      echo "  upgrade   Upgrade flowslot to latest version"
      echo "  version   Show flowslot version"
      exit 1
    fi
    case "$1" in
      init)
        shift
        "$SCRIPT_DIR/slot-self-init" "$@"
        ;;
      upgrade)
        shift
        "$SCRIPT_DIR/slot-self-upgrade" "$@"
        ;;
      version)
        "$SCRIPT_DIR/slot-self-version"
        ;;
      *)
        log_error "Unknown subcommand: $1"
        echo ""
        echo "Available subcommands:"
        echo "  init      Initialize flowslot for this project"
        echo "  upgrade   Upgrade flowslot to latest version"
        echo "  version   Show flowslot version"
        exit 1
        ;;
    esac
    ;;
  *)
    log_error "Unknown command: $1"
    echo ""
    show_help
    exit 1
    ;;
esac

