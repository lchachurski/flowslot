#!/bin/bash
# Main entry point for flowslot CLI
# Usage: slot <command> [args]

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
LIB_DIR="$SCRIPT_DIR/lib"

# Source common functions
# shellcheck source=lib/common.sh
source "$LIB_DIR/common.sh"

show_help() {
  cat << EOF
Usage: slot <command> [args]

Commands:
  init              Initialize flowslot for this project
  open <name>       Open/create a slot
  resume [name]     Resume an existing slot
  close <name>      Close/stop a slot
  list              List all slots
  info <name>       Show slot details (URLs, ports, containers)
  compose <name>    Proxy docker compose commands to remote slot
  status            Show remote server resource usage
  update            Update flowslot to latest version
  version           Show flowslot version
  server start      Start EC2 instance
  server stop       Stop EC2 instance
  server status     Show EC2 instance status

Options:
  -h, --help        Show this help message
  -v, --version     Show version

For more information, run: slot <command> --help
EOF
}

# Handle help and version flags
if [ "${1:-}" = "-h" ] || [ "${1:-}" = "--help" ]; then
  show_help
  exit 0
fi

if [ "${1:-}" = "-v" ] || [ "${1:-}" = "--version" ]; then
  "$SCRIPT_DIR/slot-version"
  exit 0
fi

# Handle empty command
if [ -z "${1:-}" ]; then
  show_help
  exit 1
fi

case "$1" in
  init)
    shift
    "$SCRIPT_DIR/slot-init" "$@"
    ;;
  open)
    shift
    if ! CONFIG_FILE=$(find_config); then
      die ".slotconfig not found. Run 'slot init' first."
    fi
    # shellcheck source=/dev/null
    set -a  # Auto-export all variables
    source "$CONFIG_FILE"
    set +a
    "$SCRIPT_DIR/slot-open" "$@"
    ;;
  resume)
    shift
    if ! CONFIG_FILE=$(find_config); then
      die ".slotconfig not found. Run 'slot init' first."
    fi
    # shellcheck source=/dev/null
    set -a
    source "$CONFIG_FILE"
    set +a
    "$SCRIPT_DIR/slot-resume" "$@"
    ;;
  close)
    shift
    if ! CONFIG_FILE=$(find_config); then
      die ".slotconfig not found. Run 'slot init' first."
    fi
    # shellcheck source=/dev/null
    set -a
    source "$CONFIG_FILE"
    set +a
    "$SCRIPT_DIR/slot-close" "$@"
    ;;
  list)
    shift
    if ! CONFIG_FILE=$(find_config); then
      die ".slotconfig not found. Run 'slot init' first."
    fi
    # shellcheck source=/dev/null
    set -a
    source "$CONFIG_FILE"
    set +a
    "$SCRIPT_DIR/slot-list" "$@"
    ;;
  status)
    shift
    if ! CONFIG_FILE=$(find_config); then
      die ".slotconfig not found. Run 'slot init' first."
    fi
    # shellcheck source=/dev/null
    set -a
    source "$CONFIG_FILE"
    set +a
    "$SCRIPT_DIR/slot-status" "$@"
    ;;
  info)
    shift
    if ! CONFIG_FILE=$(find_config); then
      die ".slotconfig not found. Run 'slot init' first."
    fi
    # shellcheck source=/dev/null
    set -a
    source "$CONFIG_FILE"
    set +a
    "$SCRIPT_DIR/slot-info" "$@"
    ;;
  compose)
    shift
    if ! CONFIG_FILE=$(find_config); then
      die ".slotconfig not found. Run 'slot init' first."
    fi
    # shellcheck source=/dev/null
    set -a
    source "$CONFIG_FILE"
    set +a
    "$SCRIPT_DIR/slot-compose" "$@"
    ;;
  server)
    shift
    if CONFIG_FILE=$(find_config 2>/dev/null); then
      set -a
      source "$CONFIG_FILE"
      set +a
    fi
    "$SCRIPT_DIR/slot-server" "$@"
    ;;
  update)
    shift
    "$SCRIPT_DIR/slot-update" "$@"
    ;;
  version)
    "$SCRIPT_DIR/slot-version"
    ;;
  *)
    log_error "Unknown command: $1"
    echo ""
    show_help
    exit 1
    ;;
esac

