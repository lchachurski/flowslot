#!/bin/bash
# Stop a slot
# Usage: slot stop [name]

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
LIB_DIR="$SCRIPT_DIR/lib"

# Source common functions
# shellcheck source=lib/common.sh
source "$LIB_DIR/common.sh"

show_help() {
  cat << EOF
Usage: slot stop [name]

Stops a development slot (keeps files).

Arguments:
  name      Slot name (optional if inside a slot directory)

Options:
  -h, --help    Show this help message

Examples:
  slot stop auth
  slot stop feature-branch
  slot stop                    # Auto-detects slot name from current directory
EOF
}

# Handle help flag
if [ "${1:-}" = "-h" ] || [ "${1:-}" = "--help" ]; then
  show_help
  exit 0
fi

# Auto-detect slot name if not provided
if [ -z "${1:-}" ]; then
  if ! SLOT_NAME=$(detect_slot_name 2>/dev/null); then
    log_error "Slot name required (not inside a slot directory)"
    echo ""
    show_help
    exit 1
  fi
else
  SLOT_NAME="$1"
fi

# Validate slot name
validate_slot_name "$SLOT_NAME"
REMOTE_PATH="$SLOT_REMOTE_BASE/$SLOT_NAME"
SYNC_NAME="${SLOT_PROJECT_NAME}-${SLOT_NAME}"

# Check if slot exists
if ! ssh "$SLOT_REMOTE_HOST" "[ -d '$REMOTE_PATH' ]" 2>/dev/null; then
  die "Slot '$SLOT_NAME' not found on remote"
fi

log_info "Stopping slot '$SLOT_NAME'..."

# Stop containers
log_info "Stopping containers..."
ssh "$SLOT_REMOTE_HOST" bash << REMOTE_SCRIPT
  set -e
  cd '$REMOTE_PATH'
  export COMPOSE_PROJECT_NAME="${SLOT_PROJECT_NAME}-${SLOT_NAME}"
  SLOT_COMPOSE_FILES="${SLOT_COMPOSE_FILES}"
  
  # Build compose command from configured files
  COMPOSE_CMD="docker compose"
  for f in \$SLOT_COMPOSE_FILES; do
    COMPOSE_CMD="\$COMPOSE_CMD -f \$f"
  done
  
  # Add flowslot override file if it exists
  if [ -f 'docker-compose.flowslot.yml' ]; then
    COMPOSE_CMD="\$COMPOSE_CMD -f docker-compose.flowslot.yml"
  fi
  
  eval "\$COMPOSE_CMD down" 2>/dev/null || docker compose down 2>/dev/null || true
REMOTE_SCRIPT

# Terminate Mutagen sync
log_info "Stopping sync..."
mutagen sync terminate "$SYNC_NAME" 2>/dev/null || true

success "Slot '$SLOT_NAME' stopped"

